# Публикация NPM
Я прошерстил много сайтов в поиске рецепта для простого способа публикации библиотеки реакт-компонентов в виде npm-пакета, и нашел несколько рабочих вариантов. Но, к сожалению, все они не учитывали особенности связанные с тем, что проект использует TypeScript, а предполагают что он написан на чистом JavaScrip.

Поэтому мне пришлось самому составить эту памятку по результатам своих манипуляций.

## 1 Создание проекта
Я предпочитаю по возможности использовать готовые инструменты, а не изобретать велосипед. Поэтому для создания проекта использую `Create React App`. Для создания проекта, который будет написан на TypeScript следует использовать команду:

```
npx create-react-app my-app --template typescript
```

Будет создан проект полностью сконфигурированный для работы с TypeScript.

## 2 Подготовка структуры проекта
В процессе создания библиотеки, скорее всего, захочется ее тестировать и отлаживать. Я использую для этого созданные на предыдущем шаге рабочие файлы в папке `src`:

```
src
  App.css
  App.tsx
  index.css
  index.tsx
```

Файлы `react-app-env.d.ts`, `reportWebVitals.ts` и `setupTests.ts` не трогаю.

Файлы библиотеки будем располагать в каталоге `src/lib`, структура которого будет следующей:

```
src
  lib
    components
    tests
    index.css
    index.ts
```

Тут все очевидно: компоненты располагаем в `components`, тесты в `tests`, точка входа в библиотеку будет в `index.ts`, стили в `index.css`.

## 3 Подготовка package.json
Из коробки `Create React App` создает минималистичный package.json. Для публикации его необходимо дополнить:
* `name` - указать реальное название пакета. Мне лень искать адекватное название в общем пространстве имен, поэтому я буду использовать собственное: `@alxgrn/react-form`.
* `description` - описание.
* `private` - надо поставить в `true`.
* `author` - укажем автора, пусть все знают!
* `license` - указать лицензию. Я выбрал `Apache-2.0`. Название надо указывать в правильном формате, если сомневаетесь, потренируйтесь с использованием команды `npm init` в каком-нибудь пустом каталоге.
* `keywords` - массив ключевых слов для облегчения поиска пакета.
* `main` и `module` - точка входа в бублиотеку. Мы будем располагать готовые файлы в каталоге `dist` с точкой входа `dist/index.js`. Надо отметить что поле `module` отсуствует в документации, но повсеместно используется. Зачем оно нужно при наличии `main` - загадка, которую лень разгадывать, поэтому просто напишем и все.
* `files` - массив файлов, которые будем публиковать. Мы указываем каталог `dist`, куда сложим готовый проект. По умолчанию также будут добавлены `README` и `LICENSE`, причем с любыми расширениями и регистром.
* `homepage`, `repository`, `bugs` - тут все понятно.

 **ВАЖНО:** После того как вы укажете в `homepage` что-то типа:

 ```
 "homepage": "https://github.com/alxgrn/react-form#readme",
 ```

 Ваше тестовое приложение перестанет работать т.к. после сборки будет искать файлы проекта хрен знает где. Для фикса этой неприятности необходимо подправить в секции `scripts` запуск команды `start` следующим образом:

 ```
 "start": "PUBLIC_URL=/ react-scripts start",
 ```

## 4 Установка и настройка babel
Обидно осознавать что `Create React App` умеет делать все, что нам надо для сборки проекта, но делает это где-то у себя внутри по своим правилам, в которые нас не особо посвящает. Было бы здорово, если бы он умел сразу готовить проект к публикации, но нет, так нет. Будем сами.

Для преобразования TypeScript в JavaScript, который затем перегоним в "древний" JavaScript мы будем использовать babel. Установим его в проект:

```
npm install --save-dev @babel/cli @babel/core @babel/preset-env @babel/preset-react @babel/preset-typescript
```

Сконфигурируем babel создав в корне файл `babel.config.json` с следующим содержанием:

```
{
    "comments": false,
    "presets": [
        [
            "@babel/preset-env",
                {
                    "targets": "> 0.25%, not dead",
                    "useBuiltIns": "usage",
                    "corejs": "3.6.5"
                }
        ],
        "@babel/preset-react",
        "@babel/preset-typescript"
    ],
    "ignore": [
        "**/tests",
        "**/*.d.ts"
    ]
}
```
Мы удаляем из результата комментарии, игнорируем файлы тестов (которые будем держать в каталоге `src/lib/tests`) и объявления типов (о которых ниже).

Теперь добавим в раздел `scripts` в файле `package.json` скрипт для запуска билда:

```
"build:js": "rm -rf dist && NODE_ENV=production babel src/lib --out-dir dist --copy-files --extensions \".ts,.tsx\" --source-maps true"
```

Как уже отмечалось ранее, мы будем складывать результат сборки в каталог `dist` в корне проекта. Поэтому первое что делает этот скрипт - удаляет предыдущую сборку. Затем он устанавливает переменную среды окружения в продакшен режим и запускает babel. Babel будет искать для обработки файлы с расширениями `.ts,.tsx` (кроме тех что указали в блоке `ignore` в файле конфигурации) в каталоге `src/lib`, результат записывать в каталог `dist`. Необработанные файлы будут просто скопированы в `dist`. Также будут созданы файлы с sourcemap.

## 5 Генерация файлов объвления типов
Для полного счастья пользователей нашей библиотеки и общего порядка, нам необходимо чтобы в дистрибутиве находились файлы объявления типов.

На предыдущем шаге мы уже сказали babel не обрабатывать эти файлы, а просто скопировать в папку `dist`. Теперь осталось их сгенерировать. Так как мы использовали `Create React App` у нас уже есть компилятор tsc, поэтому просто воспользуемся им. Добавим в раздел `scripts` файла `package.json` следующую команду:

```
"build:types": "./node_modules/.bin/tsc --project ./tsconfig.types.json",
```

Обратите внимание на то, что мы указываем компилятору использовать файл проекта `tsconfig.types.json`. Мы не можем использовать файл `tsconfig.json`, который для нас создал `Create React App` т.к. в нем установлен флаг `noEmit`, который не совместим с нужным нам флагом `emitDeclarationOnly`.

Поэтому мы просто копируем файл `tsconfig.json` в `tsconfig.types.json`, затем в блоке `compilerOptions` добавляем `"declaration": true` и `"emitDeclarationOnly": true`, а `"noEmit": true` наоборот убираем.

Дополнительно мы меняем в блоке `include` каталог на `src/lib`, так как нас интересует только он.

Теперь при запуске команды
```
npm run build:types
```
компилятор создаст для нас файлы деклараций, которые мы затем сможем скопировать в дистрибутив.

## 6 Добавим команду сборки
Для создания дистрибутива нам нужно сначала сгенерировать файлы деклараций, а затем запустить babel. Для удобства добавим в раздел `scripts` в файле `package.json` команду, которая все это сотворит:
```
"build:dist": "npm run build:types && npm run build:js && rm -rf dist/tests",
```
Дополнительно добавили удаление каталога `tests` из дистрибутива, т.к. врядли он там нужен.

## 7 Публикация пакета
Теперь все готово к публикации пакета. Но есть пара нюансов.

### 7.1
Я решил использовать в названии пакета имя своего аккаунта т.е. в терминологии npm у меня `scoped package`. По умолчанию такие пакеты считаются приватными и для их публикации надо использовать специальный флаг:
```
npm publish --access public
```
### 7.2
Прежде чем реально публиковать пакет, неплохо было бы его протестировать. Для этого есть специальные команды `npm link` и `npm unlink`.

### 7.3
Перед очередной публикацией необходимо изменить версию пакета. Можно это делать руками, а можно использовать команду `npm version`.
